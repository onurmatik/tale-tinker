{% extends "base.html" %}
{% block title %}Story Detail{% endblock %}
{% block content %}

<div class="d-flex justify-content-between">
    <h2>{{ text.title }}</h2>
    <p>
      <span
        class="like-btn fs-4"
        data-story-id="{{ story.id }}"
      >
          {% if user.is_authenticated and user in story.liked_by.all %}
              <i class="bi bi-star-fill text-warning"></i>
          {% else %}
              <i class="bi bi-star text-warning"></i>
          {% endif %}
      </span>
      <span class="like-count text-secondary">{{ story.liked_by.count }}</span>
    </p>
</div>

<p>
  {% for lang in languages %}
    {% if lang == selected_language %}
      <span class="badge text-bg-success">{{ lang|upper }}</span>
    {% else %}
      <a href="?lang={{ lang }}" class="badge text-bg-secondary text-decoration-none">{{ lang|upper }}</a>
    {% endif %}
  {% endfor %}
</p>


<div>

    {% if story.images.first %}
      <div id="image-container" class="w-50 m-2" style="float: right;">
        <img src="{{ story.images.first.image.url }}" class="img-fluid mb-3 rounded" alt="Cover image" />
      </div>
    {% else %}
      <div id="image-status" class="w-50 m-2" style="float: right;">
        <div class="progress">
          <div id="image-progress" class="progress-bar progress-bar-striped progress-bar-animated" data-duration="20000" style="width: 0%">Creating image...</div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const bar = document.getElementById('image-progress');
          if (bar) {
            const duration = parseInt(bar.dataset.duration, 10) || 20000;
            const start = Date.now();
            const timer = setInterval(() => {
              const elapsed = Date.now() - start;
              const percent = Math.min(100, (elapsed / duration) * 100);
              bar.style.width = percent + '%';
              if (percent >= 100) clearInterval(timer);
            }, 200);
          }
          fetch('/api/create_image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ story_id: {{ story.id }} })
          }).then(resp => { if (resp.ok) location.reload(); });
        });
      </script>
      {% endif %}

    {% if audio %}
      <div id="audio-container" class="my-3">
        <audio id="story-audio" controls>
          <source src="{{ audio.mp3.url }}" type="audio/mpeg" />
        </audio>
      </div>
    {% else %}
      <div id="audio-status" class="my-3">
        <div class="progress">
          <div id="audio-progress" class="progress-bar progress-bar-striped progress-bar-animated" data-duration="30000" style="width: 0%">Creating audio...</div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const bar = document.getElementById('audio-progress');
          if (bar) {
            const duration = parseInt(bar.dataset.duration, 10) || 30000;
            const start = Date.now();
            const timer = setInterval(() => {
              const elapsed = Date.now() - start;
              const percent = Math.min(100, (elapsed / duration) * 100);
              bar.style.width = percent + '%';
              if (percent >= 100) clearInterval(timer);
            }, 200);
          }
          fetch('/api/create_audio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ story_id: {{ story.id }}, language: '{{ selected_language }}' })
          }).then(resp => { if (resp.ok) location.reload(); });
        });
      </script>
      {% endif %}

    {% if text %}
      <p>{{ text.text|linebreaks }}</p>
    {% else %}
      <div id="text-status" class="my-3">
        <div class="progress">
          <div id="text-progress" class="progress-bar progress-bar-striped progress-bar-animated" data-duration="10000" style="width: 0%">Creating text...</div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const bar = document.getElementById('text-progress');
          if (bar) {
            const duration = parseInt(bar.dataset.duration, 10) || 10000;
            const start = Date.now();
            const timer = setInterval(() => {
              const elapsed = Date.now() - start;
              const percent = Math.min(100, (elapsed / duration) * 100);
              bar.style.width = percent + '%';
              if (percent >= 100) clearInterval(timer);
            }, 200);
          }
          fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ story_id: {{ story.id }}, language: '{{ selected_language }}' })
          }).then(resp => { if (resp.ok) location.reload(); });
        });
      </script>
      {% endif %}

</div>

<div style="clear: both;"></div>
{% endblock %}
